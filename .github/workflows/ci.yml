name: CI - Unit, BDD, Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore (solution)
        run: dotnet restore examen-2025-ii-si784-u2-JMedina255.sln

      - name: Build (solution)
        run: dotnet build examen-2025-ii-si784-u2-JMedina255.sln --no-restore -c Release

      - name: Unit tests with coverage (gate 80%)
        run: |
          dotnet test tests/App.UnitTests/App.UnitTests.csproj \
            -c Release --no-build \
            --logger "trx;LogFileName=unit-tests.trx" \
            /p:CollectCoverage=true \
            /p:CoverletOutput=TestResults/coverage/ \
            /p:CoverletOutputFormat="cobertura,lcov" \
            /p:Threshold=80 \
            /p:ThresholdType=line \
            /p:Include="[App.Core]*"

      - name: BDD tests
        run: dotnet test tests/App.BDD/App.BDD.csproj -c Release --no-build --logger "trx;LogFileName=bdd-tests.trx"

      - name: Install reporting tools
        run: |
          dotnet tool update -g dotnet-reportgenerator-globaltool
          dotnet tool update -g SpecFlow.Plus.LivingDoc.CLI

      - name: Generate coverage report
        shell: bash
        run: |
          mkdir -p docs/coverage
          reportgenerator -reports:"**/TestResults/*/coverage.cobertura.xml" -targetdir:"docs/coverage" -reporttypes:"HtmlInline_AzurePipelines;Cobertura"

      - name: Generate LivingDoc report
        shell: bash
        run: |
          mkdir -p docs/bdd
          DLL=$(find tests/App.BDD -type f -name 'App.BDD.dll' | head -n 1)
          JSON=$(find tests/App.BDD -type f -name 'TestExecution.json' | head -n 1)
          if [ -z "$JSON" ]; then JSON=$(find tests/App.BDD -path '*/TestResults/*/TestExecution.json' | head -n 1); fi
          livingdoc test-assembly "$DLL" -t "$JSON" -o docs/bdd

      - name: Create docs index
        shell: bash
        run: |
          mkdir -p docs
          cat > docs/index.html <<'HTML'
          <html><head><meta charset="utf-8"><title>Reportes</title></head><body>
          <h1>Reportes de Pruebas</h1>
          <ul>
            <li><a href="coverage/index.html">Cobertura (coverlet)</a></li>
            <li><a href="bdd/index.html">BDD LivingDoc</a></li>
          </ul>
          </body></html>
          HTML

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
